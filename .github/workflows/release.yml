name: Release and Publish

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch: # Allows manual triggering

jobs:
  build_wheels:
    name: Build Wheels (${{ matrix.platform }})

    strategy:
      matrix:
        include:
          - platform: macos # cibuildwheel platform identifier
            os: macos-latest # GitHub Actions runner OS
            archs: "x86_64 arm64"
          - platform: windows # cibuildwheel platform identifier
            os: windows-latest # GitHub Actions runner OS
            archs: "auto"
          - platform: linux # cibuildwheel platform identifier (builds manylinux)
            os: ubuntu-latest # GitHub Actions runner OS (runs Docker)
            archs: "auto"
      fail-fast: false # Don't cancel all jobs if one platform fails

    runs-on: ${{ matrix.os }}
    
    env:
      CIBW_ARCHS: ${{ matrix.archs }}

    steps:
      - name: Check out main repository
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Set up SSH access for private submodule (Bash)
        shell: bash
        run: |
          mkdir -p ~/.ssh
          # Decode if Base64 encoded, otherwise echo directly. Assuming direct key content for now.
          echo "${{ secrets.SUBMODULE_DEPLOY_KEY }}" | tr -d '\r' > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          echo "SSH key setup complete."
          # Add a verification step: Try to load the key fingerprint
          echo "Verifying key load..."
          ssh-keygen -l -f ~/.ssh/id_ed25519 || (echo "ERROR: Failed to load key fingerprint. Key format in secret is likely invalid." && exit 1)
          echo "Key loaded successfully by ssh-keygen."

      - name: Configure Git to use SSH for github.com
        run: git config --global url."git@github.com:".insteadOf "https://github.com/"
        shell: bash

      - name: Initialize submodules
        run: |
          git submodule sync --recursive
          git submodule update --init --recursive
        shell: bash

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install cibuildwheel
        run: python -m pip install --upgrade pip cibuildwheel

      - name: Build wheels for ${{ matrix.platform }}
        run: cibuildwheel --platform ${{ matrix.platform }}

      - name: Upload wheels (${{ matrix.platform }})
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.platform }}
          path: ./wheelhouse

  publish-testpypi:
    name: Publish to TestPyPI
    needs: build_wheels # Run after wheels are built
    runs-on: ubuntu-latest
    # Define environment linked to TestPyPI trusted publishing config
    environment:
      name: test-pypi # MUST match the environment name configured in TestPyPI trusted publishing
      url: https://test.pypi.org/p/bitepy # Link to your project on TestPyPI (replace 'bite' if needed)
    permissions:
      id-token: write # Allow workflow to get OIDC ID token for PyPI
      contents: read # Allow checkout if needed (though not strictly required by pypi-publish)
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') && contains(github.ref_name, '-'))

    steps:
      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true # Combine contents if artifacts have same name (shouldn't happen here)

      - name: List downloaded wheels
        run: ls -R dist/

      - name: Publish package to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository_url: https://test.pypi.org/legacy/

  publish-pypi:
    name: Publish to PyPI
    needs: build_wheels # Run after wheels are built
    runs-on: ubuntu-latest
    environment:
      name: pypi # MUST match the environment name configured in PyPI trusted publishing
      url: https://pypi.org/p/bitepy # Link to your project on PyPI (replace 'bite' if needed)
    permissions:
      id-token: write # Allow workflow to get OIDC ID token for PyPI
      contents: read
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') && !contains(github.ref_name, '-')

    steps:
      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true

      - name: List downloaded wheels
        run: ls -R dist/

      - name: Publish package to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

  create-github-release:
    name: Create GitHub Release
    needs: build_wheels # Run after wheels are built
    runs-on: ubuntu-latest
    permissions:
      contents: write # Need write access to create release and upload assets

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true

      - name: List downloaded wheels
        run: ls -R dist/

      - name: Check if release already exists
        id: check_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ github.ref_name }}
        run: |
          echo "Checking if release already exists for tag ${TAG_NAME}"
          if gh release view "$TAG_NAME" >/dev/null 2>&1; then
            echo "Release ${TAG_NAME} already exists, skipping creation"
            echo "release_exists=true" >> $GITHUB_OUTPUT
          else
            echo "Release ${TAG_NAME} does not exist, will create"
            echo "release_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release and Upload Assets
        if: steps.check_release.outputs.release_exists == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ github.ref_name }}
        run: |
          echo "Creating release for tag ${TAG_NAME}"
          # Set --prerelease flag if tag name contains a hyphen (e.g., -rc, -alpha, -beta)
          PRE_RELEASE_FLAG=""
          if [[ "$TAG_NAME" == *"-"* ]]; then
            PRE_RELEASE_FLAG="--prerelease"
            echo "Marking as pre-release."
          fi
          # Create release using GitHub CLI, auto-generate notes, upload all wheels
          gh release create "$TAG_NAME" \
             --title "Release ${TAG_NAME}" \
             --generate-notes \
             $PRE_RELEASE_FLAG \
             dist/*.whl # Upload all downloaded wheels